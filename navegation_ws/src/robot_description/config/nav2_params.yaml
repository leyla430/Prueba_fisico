amcl:
  ros__parameters:
    use_sim_time: true

bt_navigator:
  ros__parameters:
    use_sim_time: true
    default_nav_to_pose_bt_xml: "navigate_to_pose_w_replanning_and_recovery.xml"
    default_nav_through_poses_bt_xml: "navigate_through_poses_w_replanning_and_recovery.xml"

controller_server:
  ros__parameters:
    use_sim_time: true
    controller_plugins: ["FollowPath"]
    min_x_velocity_threshold: 0.001
    min_theta_velocity_threshold: 0.001
    FollowPath:
      plugin: "dwb_core::DWBLocalPlanner"
      debug_trajectory_details: false
      min_vel_x: 0.0
      max_vel_x: 0.5
      min_vel_theta: 0.0
      max_vel_theta: 1.0
      acc_lim_x: 1.5
      acc_lim_theta: 3.2
      decel_lim_x: -1.5
      decel_lim_theta: -3.2
      vx_samples: 20
      vtheta_samples: 40
      sim_time: 1.5
      linear_granularity: 0.05
      angular_granularity: 0.025
      critic_plugins: ["ObstacleFootprint", "GoalAlign", "PathAlign", "PathDist", "GoalDist"]
      ObstacleFootprint: {plugin: "dwb_critics::ObstacleFootprintCritic"}
      PathAlign:         {plugin: "dwb_critics::PathAlignCritic"}
      GoalAlign:         {plugin: "dwb_critics::GoalAlignCritic"}
      PathDist:          {plugin: "dwb_critics::PathDistCritic"}
      GoalDist:          {plugin: "dwb_critics::GoalDistCritic"}

planner_server:
  ros__parameters:
    use_sim_time: true
    planner_plugins: ["GridBased"]
    GridBased:
      plugin: "nav2_navfn_planner/NavfnPlanner"
      tolerance: 0.5
      use_astar: false

smoother_server:
  ros__parameters:
    use_sim_time: true
    smoother_plugins: ["simple_smoother"]
    simple_smoother:
      plugin: "nav2_smoother::SimpleSmoother"

behavior_server:
  ros__parameters:
    use_sim_time: true
    enable_stopped_behavior: true
    progress_checker_plugin: "progress_checker"
    goal_checker_plugins: ["goal_checker"]
    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"
      required_movement_radius: 0.5
      movement_time_allowance: 10.0
    goal_checker:
      plugin: "nav2_controller::SimpleGoalChecker"
      xy_goal_tolerance: 0.10
      yaw_goal_tolerance: 0.10

waypoint_follower:
  ros__parameters:
    use_sim_time: true
    loop_rate: 20
    stop_on_failure: false

# ------- COSTMAPS (solo /scan por ahora) -------
local_costmap:
  local_costmap:
    ros__parameters:
      use_sim_time: true
      update_frequency: 10.0
      publish_frequency: 5.0
      global_frame: odom
      robot_base_frame: base_link
      rolling_window: true
      width: 6.0
      height: 6.0
      resolution: 0.05
      robot_radius: 0.25
      transform_tolerance: 0.2
      plugins: ["obstacle_layer", "inflation_layer"]

      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        observation_sources: scan
        scan:
          topic: /scan
          data_type: LaserScan
          expected_update_rate: 0.0
          clearing: true
          marking: true
          max_obstacle_height: 1.5
          obstacle_range: 2.0
          raytrace_range: 2.5

      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        inflation_radius: 0.6
        cost_scaling_factor: 3.0

global_costmap:
  global_costmap:
    ros__parameters:
      use_sim_time: true
      update_frequency: 2.0
      publish_frequency: 2.0
      global_frame: map
      robot_base_frame: base_link
      width: 40.0
      height: 40.0
      resolution: 0.05
      robot_radius: 0.25
      rolling_window: false
      transform_tolerance: 0.5
      plugins: ["static_layer", "obstacle_layer", "inflation_layer"]

      static_layer:
        plugin: "nav2_costmap_2d::StaticLayer"
        map_subscribe_transient_local: true

      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        observation_sources: scan
        scan:
          topic: /scan
          data_type: LaserScan
          clearing: true
          marking: true
          obstacle_range: 2.0
          raytrace_range: 2.5
          max_obstacle_height: 1.5

      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        inflation_radius: 0.8
        cost_scaling_factor: 3.0

velocity_smoother:
  ros__parameters:
    use_sim_time: true
    smoothing_frequency: 20.0
    feedback: "OPEN_LOOP"
    odom_topic: "/odom"
    scale_velocities: false
    max_velocity: [0.6, 0.0, 1.2]
    min_velocity: [0.0, 0.0, 0.0]
    max_accel:    [1.0, 0.0, 2.0]
    max_decel:    [-1.0, 0.0, -2.0]






# ------------------ NAV2 COMPLETO ------------------

# # nav2_params.yaml (ROS 2 Humble, navegación con SLAM en vivo)

# amcl:  # no se usa con SLAM, pero la sección puede existir sin lanzar amcl
#   ros__parameters:
#     use_sim_time: true

# bt_navigator:
#   ros__parameters:
#     use_sim_time: true
#     default_nav_to_pose_bt_xml: "navigate_to_pose_w_replanning_and_recovery.xml"
#     default_nav_through_poses_bt_xml: "navigate_through_poses_w_replanning_and_recovery.xml"

# controller_server:
#   ros__parameters:
#     use_sim_time: true
#     controller_plugins: ["FollowPath"]
#     min_x_velocity_threshold: 0.001
#     min_theta_velocity_threshold: 0.001
#     FollowPath:
#       plugin: "dwb_core::DWBLocalPlanner"
#       debug_trajectory_details: false
#       min_vel_x: 0.0
#       max_vel_x: 0.5
#       min_vel_theta: 0.0
#       max_vel_theta: 1.0
#       acc_lim_x: 1.5
#       acc_lim_theta: 3.2
#       decel_lim_x: -1.5
#       decel_lim_theta: -3.2
#       vx_samples: 20
#       vtheta_samples: 40
#       sim_time: 1.5
#       linear_granularity: 0.05
#       angular_granularity: 0.025
#       critic_plugins: ["ObstacleFootprint", "GoalAlign", "PathAlign", "PathDist", "GoalDist"]
#       ObstacleFootprint:
#         plugin: "dwb_critics::ObstacleFootprintCritic"
#       PathAlign:
#         plugin: "dwb_critics::PathAlignCritic"
#       GoalAlign:
#         plugin: "dwb_critics::GoalAlignCritic"
#       PathDist:
#         plugin: "dwb_critics::PathDistCritic"
#       GoalDist:
#         plugin: "dwb_critics::GoalDistCritic"

# planner_server:
#   ros__parameters:
#     use_sim_time: true
#     planner_plugins: ["GridBased"]
#     GridBased:
#       plugin: "nav2_navfn_planner/NavfnPlanner"
#       tolerance: 0.5
#       use_astar: false

# smoother_server:
#   ros__parameters:
#     use_sim_time: true
#     smoother_plugins: ["simple_smoother"]
#     simple_smoother:
#       plugin: "nav2_smoother::SimpleSmoother"

# behavior_server:
#   ros__parameters:
#     use_sim_time: true
#     enable_stopped_behavior: true
#     progress_checker_plugin: "progress_checker"
#     goal_checker_plugins: ["goal_checker"]
#     progress_checker:
#       plugin: "nav2_controller::SimpleProgressChecker"
#       required_movement_radius: 0.5
#       movement_time_allowance: 10.0
#     goal_checker:
#       plugin: "nav2_controller::SimpleGoalChecker"
#       xy_goal_tolerance: 0.10
#       yaw_goal_tolerance: 0.10

# waypoint_follower:
#   ros__parameters:
#     use_sim_time: true
#     loop_rate: 20
#     stop_on_failure: false

# # -------- COSTMAPS --------
# local_costmap:
#   local_costmap:
#     ros__parameters:
#       use_sim_time: true
#       update_frequency: 10.0
#       publish_frequency: 5.0
#       global_frame: odom
#       robot_base_frame: base_link
#       rolling_window: true
#       width: 6.0
#       height: 6.0
#       resolution: 0.05
#       robot_radius: 0.25
#       plugins: ["obstacle_layer", "inflation_layer"]
#       transform_tolerance: 0.2

#       obstacle_layer:
#         plugin: "nav2_costmap_2d::ObstacleLayer"
#         observation_sources: scan ultra_front_der ultra_front_izq ultra_atras_der ultra_atras_izq
#         # LIDAR 2D sintetizado desde tu 3D
#         scan:
#           topic: /scan
#           data_type: LaserScan
#           expected_update_rate: 0.0
#           clearing: true
#           marking: true
#           max_obstacle_height: 1.5
#           obstacle_range: 2.0
#           raytrace_range: 2.5
#         # Ultrasonidos (LaserScan de haz estrecho)
#         ultra_front_der:
#           topic: /ultra_front_der
#           data_type: LaserScan
#           clearing: true
#           marking: true
#           obstacle_range: 2.5
#           raytrace_range: 3.0
#         ultra_front_izq:
#           topic: /ultra_front_izq
#           data_type: LaserScan
#           clearing: true
#           marking: true
#           obstacle_range: 2.5
#           raytrace_range: 3.0
#         ultra_atras_der:
#           topic: /ultra_atras_der
#           data_type: LaserScan
#           clearing: true
#           marking: true
#           obstacle_range: 2.5
#           raytrace_range: 3.0
#         ultra_atras_izq:
#           topic: /ultra_atras_izq
#           data_type: LaserScan
#           clearing: true
#           marking: true
#           obstacle_range: 2.5
#           raytrace_range: 3.0

#       inflation_layer:
#         plugin: "nav2_costmap_2d::InflationLayer"
#         inflation_radius: 0.6
#         cost_scaling_factor: 3.0

# global_costmap:
#   global_costmap:
#     ros__parameters:
#       use_sim_time: true
#       update_frequency: 2.0
#       publish_frequency: 2.0
#       global_frame: map
#       robot_base_frame: base_link
#       width: 40.0         # ajusta al tamaño de tu mundo
#       height: 40.0
#       resolution: 0.05
#       robot_radius: 0.25
#       rolling_window: false
#       transform_tolerance: 0.5
#       plugins: ["static_layer", "obstacle_layer", "inflation_layer"]

#       static_layer:
#         plugin: "nav2_costmap_2d::StaticLayer"
#         map_subscribe_transient_local: true

#       obstacle_layer:
#         plugin: "nav2_costmap_2d::ObstacleLayer"
#         observation_sources: scan
#         scan:
#           topic: /scan
#           data_type: LaserScan
#           clearing: true
#           marking: true
#           obstacle_range: 2.0
#           raytrace_range: 2.5
#           max_obstacle_height: 1.5

#       inflation_layer:
#         plugin: "nav2_costmap_2d::InflationLayer"
#         inflation_radius: 0.8
#         cost_scaling_factor: 3.0

# # El navigation_launch remapea controller_server: cmd_vel -> cmd_vel_nav.
# # Este nodo convierte cmd_vel_nav -> cmd_vel (que es lo que escucha tu diff_drive).
# velocity_smoother:
#   ros__parameters:
#     use_sim_time: true
#     smoothing_frequency: 20.0
#     feedback: "OPEN_LOOP"
#     odom_topic: "/odom"
#     scale_velocities: false
#     max_velocity: [0.6, 0.0, 1.2]      # [vx, vy, vtheta]
#     min_velocity: [0.0, 0.0, 0.0]
#     max_accel:    [1.0, 0.0, 2.0]
#     max_decel:    [-1.0, 0.0, -2.0]
