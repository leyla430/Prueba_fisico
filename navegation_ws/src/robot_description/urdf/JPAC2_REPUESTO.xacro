<?xml version="1.0"?>
<robot name="JPAC2" xmlns:xacro="http://www.ros.org/wiki/xacro">


  <!-- Ruta a stl -->
  <xacro:arg name="meshes_path" default="package://robot_description/meshes/visual"/>
  <xacro:property name="meshes_path" value="$(arg meshes_path)"/>



  <link name="base_footprint"/>
  <joint name="base_joint" type="fixed">
    <parent link="base_footprint"/>
    <child link="base_link" />
    <origin xyz="0 0 0.146" rpy="0 0 1.5708"/>  <!-- ============= ROTACION PARA NAV2 ======== -->
  </joint>


<!-- ====================== PRUEBAS DE CINEMATICA - SI DA, POCO TAMBALEO ===================== -->
  <!-- ====================== PRUEBAS DE CINEMATICA - SI DA, POCO TAMBALEO ===================== -->


  <!-- ===== Chasis ===== -->
  <link name="base_link">
    <inertial>
      <origin xyz="0 0 0.05" rpy="0 0 0"/>

      <mass value="100.0"/>

      <inertia ixx="1.0" ixy="0" ixz="0"
               iyy="23.0"  iyz="0"  izz="25.0"/>

    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="${meshes_path}/base_link.STL"/>
      </geometry>
      <material name=""><color rgba="1 1 1 1"/></material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="${meshes_path}/base_link.STL"/>
      </geometry>
    </collision>
  </link>

  <!-- ===== Subconjuntos (como en tu modelo) ===== -->
  <link name="BaseGiratoria1_Link">
    <inertial>
      <origin xyz="-0.019499 0.066863 0" rpy="0 0 0"/>
      <mass value="0.077823"/>
      <inertia ixx="8.2437E-05" ixy="-2.9935E-05" ixz="0"
               iyy="4.9106E-05" iyz="0"          izz="9.5967E-05"/>
    </inertial>
    <visual><origin xyz="0 0 0" rpy="0 0 0"/><geometry><mesh filename="${meshes_path}/BaseGiratoria1_Link.STL"/></geometry></visual>
    <collision><origin xyz="0 0 0" rpy="0 0 0"/><geometry><mesh filename="${meshes_path}/BaseGiratoria1_Link.STL"/></geometry></collision>
  </link>

  <joint name="BaseGiratoria1_join" type="continuous">
    <origin xyz="-0.0010727 -0.151 -0.02173" rpy="3.1416 0 -0.0087266"/>
    <parent link="base_link"/><child link="BaseGiratoria1_Link"/>
    <axis xyz="0 0 -1"/>
    <limit effort="100" velocity="100"/><dynamics damping="0.1" friction="0.1"/>
  </joint>






  <link name="Ruedita1_Link">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.18473"/>
      <inertia ixx="0.00013393" ixy="0" ixz="0" iyy="0.00013393" iyz="0" izz="0.00025301"/>
    </inertial>
    <visual><origin xyz="0 0 0" rpy="0 0 0"/><geometry><mesh filename="${meshes_path}/Ruedita1_Link.STL"/></geometry></visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry><mesh filename="${meshes_path}/Ruedita1_Link.STL"/></geometry>
      <surface>
        <friction><ode><mu>0.1</mu><mu2>0.1</mu2></ode></friction>
      </surface>
    </collision>
  </link>

  <joint name="Ruedita1_join" type="continuous">
    <origin xyz="-0.00024393 0.037257 0.06718" rpy="-1.5708 0 -1.5708"/>
    <parent link="BaseGiratoria1_Link"/><child link="Ruedita1_Link"/>
    <axis xyz="-0.006547 0 0.99998"/> 
    <limit effort="100" velocity="100"/>
    <dynamics damping="0.0" friction="0.0"/>
  </joint>

  <link name="BaseGiratoria2_Link">
    <inertial>
      <origin xyz="-0.019499 0.066863 0" rpy="0 0 0"/>
      <mass value="0.077823"/>
      <inertia ixx="8.2437E-05" ixy="-2.9935E-05" ixz="0"
               iyy="4.9106E-05" iyz="0"          izz="9.5967E-05"/>
    </inertial>
    <visual><origin xyz="0 0 0" rpy="0 0 0"/><geometry><mesh filename="${meshes_path}/BaseGiratoria2_Link.STL"/></geometry></visual>
    <collision><origin xyz="0 0 0" rpy="0 0 0"/><geometry><mesh filename="${meshes_path}/BaseGiratoria2_Link.STL"/></geometry></collision>
  </link>

  <joint name="BaseGiratoria2_join" type="continuous">
    <origin xyz="0.0015627 0.15099 -0.02173" rpy="-3.1416 0 3.1329"/>
    <parent link="base_link"/><child link="BaseGiratoria2_Link"/>
    <axis xyz="0 0 -1"/>
    <limit effort="100" velocity="100"/><dynamics damping="0.1" friction="0.1"/>
  </joint>

  <link name="Ruedita2_Link">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.18473"/>
      <inertia ixx="0.00013393" ixy="0" ixz="0" iyy="0.00013393" iyz="0" izz="0.00025301"/>
    </inertial>
    <visual><origin xyz="0 0 0" rpy="0 0 0"/><geometry><mesh filename="${meshes_path}/Ruedita2_Link.STL"/></geometry></visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry><mesh filename="${meshes_path}/Ruedita2_Link.STL"/></geometry>
      <surface>
        <friction><ode><mu>0.1</mu><mu2>0.1</mu2></ode></friction>
      </surface>
    </collision>
  </link>

  <joint name="Ruedita2_join" type="continuous">
    <origin xyz="0.00010817 0.037258 0.06718" rpy="-1.5708 0 -1.5708"/>
    <parent link="BaseGiratoria2_Link"/><child link="Ruedita2_Link"/>
    <axis xyz="-0.0029034 0 -1"/>
    <limits effort="100" velocity="100"/>
    <dynamics damping="0.0" friction="0.0"/>
  </joint>








  <!-- ===== Ruedas motrices ===== -->
  <link name="RuedaDerecha_Link">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>

      <mass value="38.5"/>
      <inertia ixx="0.012" ixy="0" ixz="0" iyy="0.025" iyz="0" izz="0.012"/>

    </inertial>
    <visual><origin xyz="0 0 0" rpy="0 0 0"/><geometry><mesh filename="${meshes_path}/RuedaDerecha_Link.STL"/></geometry></visual>
    <collision><origin xyz="0 0 0" rpy="0 0 0"/><geometry><mesh filename="${meshes_path}/RuedaDerecha_Link.STL"/></geometry></collision>
  </link>

  <joint name="RuedaDerecha_join" type="continuous">
    <origin xyz="0.24575 -0.0021388 -0.016" rpy="1.5708 0 1.5621"/>
    <parent link="base_link"/><child link="RuedaDerecha_Link"/>
    <axis xyz="0 0 1"/>
    <limit effort="100" velocity="100"/><dynamics damping="0.1" friction="0.1"/>
  </joint>

  <link name="RuedaIzquierda_Link">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>

      <mass value="38.5"/>
      <inertia ixx="0.012" ixy="0" ixz="0" iyy="0.025" iyz="0" izz="0.012"/>

    </inertial>
    <visual><origin xyz="0 0 0" rpy="0 0 0"/><geometry><mesh filename="${meshes_path}/RuedaIzquierda_Link.STL"/></geometry></visual>
    <collision><origin xyz="0 0 0" rpy="0 0 0"/><geometry><mesh filename="${meshes_path}/RuedaIzquierda_Link.STL"/></geometry></collision>
  </link>

  <joint name="RuedaIzquierda_join" type="continuous">
    <origin xyz="-0.24575 0.0021388 -0.016" rpy="1.5708 0 1.5621"/>
    <parent link="base_link"/><child link="RuedaIzquierda_Link"/>
    <axis xyz="0 0 1"/>
    <limit effort="100" velocity="100"/><dynamics damping="0.1" friction="0.1"/>
  </joint>


  <!-- ====================== IMU ====================== -->
  <joint name="imu_joint" type="fixed">
    <parent link="base_link"/><child link="imu_link"/>
    <origin xyz="0.0 0 0.068" rpy="0 0 0"/>
  </joint>
  <link name="imu_link"/>
  <gazebo reference="imu_link">
    <sensor name="tb3_imu" type="imu">
      <always_on>true</always_on><update_rate>200</update_rate><visualize>false</visualize>
      <imu>
        <angular_velocity>
          <x><noise type="gaussian"><mean>0.0</mean><stddev>2e-4</stddev></noise></x>
          <y><noise type="gaussian"><mean>0.0</mean><stddev>2e-4</stddev></noise></y>
          <z><noise type="gaussian"><mean>0.0</mean><stddev>2e-4</stddev></noise></z>
        </angular_velocity>
        <linear_acceleration>
          <x><noise type="gaussian"><mean>0.0</mean><stddev>1.7e-2</stddev></noise></x>
          <y><noise type="gaussian"><mean>0.0</mean><stddev>1.7e-2</stddev></noise></y>
          <z><noise type="gaussian"><mean>0.0</mean><stddev>1.7e-2</stddev></noise></z>
        </linear_acceleration>
      </imu>
      <plugin name="imu_plugin" filename="libgazebo_ros_imu_sensor.so">
        <ros><remapping>~/out:=imu</remapping></ros>
      </plugin>
    </sensor>
  </gazebo>

  <!-- ====================== LiDAR 3D (PointCloud2 /points2) ====================== -->
  <!-- Link físico del sensor -->
  <joint name="scan_joint" type="fixed">
    <parent link="base_link"/><child link="base_scan"/>
    <origin xyz="0 0 0.85" rpy="0 0 0"/>
  </joint>
  <link name="base_scan">
    <visual>
      <origin xyz="0 0 0"/><geometry><box size="0.05 0.05 0.06"/></geometry><material name="grey"/>
    </visual>
    <collision><origin xyz="0 0 0"/><geometry><box size="0.05 0.05 0.06"/></geometry></collision>
    <inertial><origin xyz="0 0 0"/><mass value="0.3"/><inertia ixx="5e-4" ixy="0" ixz="0" iyy="5e-4" iyz="0" izz="5e-4"/></inertial>
  </link>

  <!-- Sensor 3D montado en base_scan -->
  <gazebo reference="base_scan">
    <sensor name="lidar_3d" type="ray">
      <pose>0 0 0 0 0 0</pose>
      <always_on>true</always_on>
      <visualize>false</visualize>
      <update_rate>10</update_rate>
      <ray>
        <scan>
          <horizontal>
            <samples>1024</samples>
            <resolution>1</resolution>
            <min_angle>-3.14159</min_angle>
            <max_angle> 3.14159</max_angle>
          </horizontal>
          <vertical>
            <samples>32</samples>              <!-- 32–64 si quieres más “fino” -->
            <resolution>1</resolution>
            <min_angle>0.0</min_angle>         <!-- tu config -->
            <max_angle>1.57079632679</max_angle>
          </vertical>
        </scan>
        <range>
          <min>0.50</min>
          <max>3.0</max>
          <resolution>0.01</resolution>
        </range>
        <noise><type>gaussian</type><mean>0.0</mean><stddev>0.01</stddev></noise>
      </ray>

      <!-- Publica sensor_msgs/PointCloud2 en /points2 -->
      <plugin name="lidar_3d_points" filename="libgazebo_ros_ray_sensor.so">
        <ros>
          <remapping>~/out:=points2</remapping>
        </ros>
        <output_type>sensor_msgs/PointCloud2</output_type>
        <frame_name>base_scan</frame_name>
      </plugin>
    </sensor>
  </gazebo>



  <!-- ============== ESCUCHAR EN ODOM Y HAY RELACION ENTRE RVIZ Y GAZEBO ============== -->
  <gazebo>
    <plugin name="diff_drive" filename="libgazebo_ros_diff_drive.so">
      <ros>
        <remapping>cmd_vel:=cmd_vel</remapping>
        <remapping>odom:=odom</remapping>
      </ros>
      
      <update_rate>50</update_rate> 
      
      <left_joint>RuedaIzquierda_join</left_joint>
      <right_joint>RuedaDerecha_join</right_joint>

      <wheel_separation>0.416</wheel_separation>
      <wheel_diameter>0.26</wheel_diameter>

      <max_wheel_torque>5</max_wheel_torque>           
      <max_wheel_acceleration>0.1</max_wheel_acceleration> 

      <command_topic>cmd_vel</command_topic>

      <publish_odom>true</publish_odom>
      <publish_odom_tf>true</publish_odom_tf> 
      <publish_wheel_tf>false</publish_wheel_tf>  

      <odometry_topic>odom</odometry_topic>
      <odometry_frame>odom</odometry_frame>
      <robot_base_frame>base_footprint</robot_base_frame> 

    </plugin>
    
    <plugin name="turtlebot3_joint_state" filename="libgazebo_ros_joint_state_publisher.so">
      <ros>
        <remapping>~/out:=joint_states</remapping>
      </ros>
      <update_rate>30</update_rate>
      <joint_name>RuedaIzquierda_join</joint_name>
      <joint_name>RuedaDerecha_join</joint_name>
    </plugin>   
  </gazebo>



</robot>